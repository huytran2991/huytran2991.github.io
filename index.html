<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Speaking Practice ‚Äî Full</title>
  <style>
    :root{
      --accent:#2b8cff;
      --bg:#f6f8fb;
      --card:#ffffff;
      --muted:#666;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:#111}
    .app{display:flex;height:100vh}
    .sidebar{width:320px;background:linear-gradient(180deg,#fff,#f7fbff);border-right:1px solid #e6eefc;padding:18px;box-sizing:border-box;overflow:auto}
    .main{flex:1;padding:18px;box-sizing:border-box;overflow:auto}
    h1{font-size:18px;margin:0 0 12px}
    .user-row{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .btn{background:var(--accent);color:#fff;padding:8px 10px;border-radius:8px;border:0;cursor:pointer}
    .btn.secondary{background:#eef5ff;color:var(--accent);border:1px solid #d7e9ff}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid #d7e9ff}
    .list-item{padding:10px;border-radius:8px;background:var(--card);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .lists{max-height:45vh;overflow:auto;margin-bottom:12px}
    input,select,textarea{padding:8px;border-radius:8px;border:1px solid #dfe9f8}
    textarea{resize:vertical}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    .sentence-row{background:var(--card);padding:12px;border-radius:8px;margin-bottom:12px;display:flex;flex-direction:column;gap:8px;box-shadow:0 1px 0 rgba(0,0,0,0.02)}
    .sentence-top{display:flex;align-items:center;gap:8px;flex-direction: row;flex-wrap: wrap;justify-content: space-between;}
    .icons{display:flex;gap:6px;flex-direction: row;flex-wrap: wrap;justify-content: flex-end;}
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;border:1px solid #eee;background:#fafbfd;cursor:pointer}
    .recognized{font-size:13px;color:var(--muted)}
    .word{display:inline-block;padding:2px 6px;border-radius:6px;margin-right:4px;cursor:pointer;border:1px dashed transparent}
    .word:hover{border-color:#eee}
    .word.correct{background:#e6fff0;color:#007a3d;border:1px solid rgba(0,122,61,0.08)}
    .word.wrong{background:#fff0f1;color:#b00020;border:1px solid rgba(176,0,32,0.06)}
    .meta{font-size:13px;color:var(--muted);display:flex;gap:8px;align-items:center}
    .small{font-size:12px;color:var(--muted)}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;gap:8px}
    footer{margin-top:16px;color:var(--muted);font-size:12px}
    .hidden{display:none}
    #btnShowHideSidebar{
      display: none;
    }
    .sidebar{
      position: relative;
    }
    @media(max-width:900px){
      .sidebar{
        position: fixed;
        overflow-y: auto;
        overflow-x: visible;
        height: 100%;
        left: -320px;
      }.app{flex-direction:column}.main{padding:12px}
      
      #btnShowHideSidebar{
        position: fixed;
        display: block;
        top: 40px;
        left: 0px;
        width: 23px;
        height: 25px;
        text-align: center;
        line-height: 20px;
        z-index: 1;
        background-color: #2b8cff;
        color: #fff;
        font-size: 20px;
      }
      .sentence-text {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar" id="sidebar">
      <h1>English Practice</h1>
      <i id="btnShowHideSidebar">‚Ä∫</i>
      <div class="user-row">
        <div id="userInfo" class="small">Not signed in</div>
        <button id="btnSignIn" class="btn">Sign in</button>
        <button id="btnSignOut" class="btn secondary hidden">Sign out</button>
      </div>

      <div style="margin-bottom:10px;">
        <input id="newListName" placeholder="T√™n danh s√°ch / ch·ªß ƒë·ªÅ" style="width:100%;margin-bottom:8px;" />
        <div style="display:flex;gap:8px">
          <button id="btnCreateList" class="btn">T·∫°o</button>
          <button id="btnDeleteList" class="btn ghost" title="Xo√° danh s√°ch hi·ªán t·∫°i">X√≥a hi·ªán t·∫°i</button>
        </div>
      </div>

      <div class="lists" id="lists"></div>

      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="btnImport" class="btn secondary">Import t·ª´ text</button>
        <button id="btnExport" class="btn secondary">Export</button>
      </div>

      <footer>
        <div class="small">L∆∞u √Ω: D√πng Chrome (desktop) tr√™n HTTPS ho·∫∑c localhost ƒë·ªÉ SpeechRecognition ho·∫°t ƒë·ªông ƒë√∫ng.</div>
      </footer>
    </div>

    <div class="main">
      <div class="topbar">
        <div style="display:flex;gap:8px;align-items:center;flex-direction: row;flex-wrap: wrap;">
          <label class="small">Danh s√°ch</label>
          <select id="selectList"></select>
          <button id="btnLoadDemo" class="btn secondary">T·∫£i demo</button>
        </div>

        <div style="display:flex;align-items:center;gap:8px;flex-direction: row;flex-wrap: wrap;">
          <label class="small">Gi·ªçng:</label>
          <select id="voiceSelect"></select>
          <label class="small">T·ªëc ƒë·ªô</label>
          <input id="rate" type="range" min="0.5" max="1.7" step="0.1" value="1" />
          <button id="btnTestVoice" class="btn">Test</button>
        </div>
      </div>

      <div style="margin-bottom:12px;">
        <textarea id="inputSentences" rows="4" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefc" placeholder="Nh·∫≠p m·ªói c√¢u ti·∫øng Anh tr√™n 1 d√≤ng"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnAddSentences" class="btn">Th√™m c√¢u v√†o danh s√°ch</button>
          <button id="btnClearSentences" class="btn secondary">Clear</button>
        </div>
      </div>

      <div id="sentences"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
  // =======================
  // CONFIG: Thay b·∫±ng Firebase config c·ªßa b·∫°n
  // =======================
  const firebaseConfig = {
    apiKey: "AIzaSyBeA6AoCyF1WjvVJw2BWmtUYyOQ1VCpMJo",
    authDomain: "english-practice-e5ebd.firebaseapp.com",
    projectId: "english-practice-e5ebd",
    storageBucket: "english-practice-e5ebd.firebasestorage.app",
    messagingSenderId: "167826255253",
    appId: "1:167826255253:web:94e29c8123fb933eba1a9c",
    measurementId: "G-3MXHFZ1RPJ"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // UI elements
  const btnSignIn = document.getElementById('btnSignIn');
  const btnSignOut = document.getElementById('btnSignOut');
  const userInfo = document.getElementById('userInfo');
  const listsEl = document.getElementById('lists');
  const selectList = document.getElementById('selectList');
  const newListName = document.getElementById('newListName');
  const btnCreateList = document.getElementById('btnCreateList');
  const btnDeleteList = document.getElementById('btnDeleteList');
  const btnImport = document.getElementById('btnImport');
  const btnExport = document.getElementById('btnExport');
  const inputSentences = document.getElementById('inputSentences');
  const btnAddSentences = document.getElementById('btnAddSentences');
  const btnClearSentences = document.getElementById('btnClearSentences');
  const sentencesEl = document.getElementById('sentences');
  const voiceSelect = document.getElementById('voiceSelect');
  const rateEl = document.getElementById('rate');
  const btnTestVoice = document.getElementById('btnTestVoice');
  const btnLoadDemo = document.getElementById('btnLoadDemo');
  const btnShowHideSidebar = document.getElementById('btnShowHideSidebar');
  // Data model
  let lists = {}; // {listId: {name, sentences: [{text, correctCount}]}}
  let currentListId = null;
  let currentUser = null;

  // Local storage keys
  const LS_KEY = 'english_practice_data_v1';
  const LS_CONFIG = 'english_practice_cfg_v1';
  let isShowSidebar = 0;
  //
  btnShowHideSidebar.addEventListener('click', ()=> {
console.log('sss');
    const sidebar = document.querySelector('#sidebar');
    if( isShowSidebar ) {
sidebar.style.left = '-320px';
btnShowHideSidebar.style.left = '0px';
isShowSidebar = 0;
    }
    else {
      sidebar.style.left = '0px';
      btnShowHideSidebar.style.left = '320px';
      isShowSidebar = 1;
    }
     

  });
  // ========== Auth ==========
  btnSignIn.addEventListener('click', async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    try { await auth.signInWithPopup(provider); }
    catch(e){ alert('Sign-in error: '+e.message); }
  });
  btnSignOut.addEventListener('click', ()=>auth.signOut());

  auth.onAuthStateChanged(async user => {
    currentUser = user;
    if(user){
      userInfo.textContent = user.displayName || user.email;
      btnSignIn.classList.add('hidden'); btnSignOut.classList.remove('hidden');
      await loadListsFromFirestore();
      await loadConfig();
    } else {
      userInfo.textContent = 'Not signed in';
      btnSignIn.classList.remove('hidden'); btnSignOut.classList.add('hidden');
      loadListsFromLocal();
      loadConfigLocal();
    }
  });

  // ========== Helpers ==========
  function normalizeText(t){
    return (t||'').trim().toLowerCase().replace(/[.,!?;:()\"'`]/g,'').replace(/\s+/g,' ');
  }
  function escapeHtml(s){return (s+'').replace(/[&<>\"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));}

  // ========== Firestore operations ==========
  async function loadListsFromFirestore(){
    if(!currentUser) return;
    try{
      const snap = await db.collection('users').doc(currentUser.uid).collection('lists').get();
      lists = {};
      snap.forEach(doc => {
        lists[doc.id] = doc.data();
      });
      if(Object.keys(lists).length===0){
        const id = await createListFirestore('Default');
        lists[id].sentences = [];
      }
      renderListsUI();
    }catch(e){console.error(e); alert('Load lists error: '+e.message);}
  }
  async function saveListToFirestore(listId){
    if(!currentUser) return;
    try{ await db.collection('users').doc(currentUser.uid).collection('lists').doc(listId).set(lists[listId]); }
    catch(e){console.error(e);}
  }
  async function createListFirestore(name){
    const docRef = db.collection('users').doc(currentUser.uid).collection('lists').doc();
    lists[docRef.id] = {name, sentences: []};
    await docRef.set(lists[docRef.id]);
    renderListsUI();
    return docRef.id;
  }
  async function deleteListFirestore(listId){
    if(!currentUser) return;
    await db.collection('users').doc(currentUser.uid).collection('lists').doc(listId).delete();
    delete lists[listId];
    if(currentListId === listId) currentListId = null;
    renderListsUI();
  }
  
  // =================================================================
  // TH√äM CH·ª®C NƒÇNG S·ª¨A T√äN DANH S√ÅCH
  // =================================================================
  async function renameList(listId) {
    const listName = lists[listId].name;
    const newName = prompt("Nh·∫≠p t√™n m·ªõi cho danh s√°ch:", listName);
    if (newName !== null && newName.trim() !== "" && newName.trim() !== listName) {
        lists[listId].name = newName.trim();
        if (currentUser) {
            await saveListToFirestore(listId);
        } else {
            saveListsToLocal();
        }
        renderListsUI(); // C·∫≠p nh·∫≠t l·∫°i giao di·ªán ƒë·ªÉ hi·ªÉn th·ªã t√™n m·ªõi
    }
  }


  // ========== Local fallback ==========
  function saveListsToLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(lists)); }
  function loadListsFromLocal(){ try{ lists = JSON.parse(localStorage.getItem(LS_KEY) || '{}') || {}; renderListsUI(); }catch(e){lists={};} }

  // ========== Config ==========
  async function loadConfig(){
    if(!currentUser) return loadConfigLocal();
    try{
      const doc = await db.collection('users').doc(currentUser.uid).collection('meta').doc('config').get();
      if(doc.exists){ applyConfig(doc.data()); } else loadConfigLocal();
    }catch(e){console.error(e); loadConfigLocal();}
  }
  function loadConfigLocal(){ try{ const cfg = JSON.parse(localStorage.getItem(LS_CONFIG)||'{}'); applyConfig(cfg); }catch(e){} }
  function applyConfig(cfg){ if(!cfg) return; if(cfg.voice) voiceSelect.value = cfg.voice; if(cfg.rate) rateEl.value = cfg.rate; }
  async function saveConfig(cfg){ localStorage.setItem(LS_CONFIG, JSON.stringify(cfg)); if(!currentUser) return; try{ await db.collection('users').doc(currentUser.uid).collection('meta').doc('config').set(cfg);}catch(e){console.error(e);} }

  // ========== UI Rendering ==========
  function renderListsUI(){
    // sidebar list
    listsEl.innerHTML = '';
    selectList.innerHTML = '';
    for(const id of Object.keys(lists)){
      const li = document.createElement('div'); li.className='list-item';
      const left = document.createElement('div'); left.innerHTML = `<strong>${escapeHtml(lists[id].name)}</strong><div class="small">${(lists[id].sentences||[]).length} c√¢u</div>`;
      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='6px';
      
      // N√∫t M·ªü
      const openBtn = document.createElement('button'); openBtn.className='btn secondary'; openBtn.textContent='M·ªü'; openBtn.onclick=()=>selectListById(id);
      
      // TH√äM N√öT S·ª¨A M·ªöI V√ÄO ƒê√ÇY
      const editBtn = document.createElement('button');
      editBtn.className = 'btn ghost';
      editBtn.textContent = 'S·ª≠a';
      editBtn.onclick = () => renameList(id);
      
      // N√∫t X√≥a
      const delBtn = document.createElement('button'); delBtn.className='btn ghost'; delBtn.textContent='X√≥a'; delBtn.onclick=async ()=>{ if(confirm('Xo√° danh s√°ch n√†y?')){ if(currentUser) await deleteListFirestore(id); else { delete lists[id]; saveListsToLocal(); } if(currentListId===id) currentListId=null; renderListsUI(); } };

      right.appendChild(openBtn); 
      right.appendChild(editBtn); // Th√™m n√∫t S·ª≠a v√†o
      right.appendChild(delBtn);
      
      li.appendChild(left); li.appendChild(right);
      listsEl.appendChild(li);

      const opt = document.createElement('option'); opt.value=id; opt.textContent=lists[id].name; selectList.appendChild(opt);
    }
    if(!currentListId){
      const keys = Object.keys(lists);
      if(keys.length) selectListById(keys[0]);
      else sentencesEl.innerHTML = '<div class="small">Ch∆∞a c√≥ danh s√°ch. T·∫°o danh s√°ch m·ªõi ·ªü b√™n tr√°i.</div>';
    } else {
      selectList.value = currentListId;
    }
  }

  function selectListById(id){
    currentListId = id;
    selectList.value = id;
    renderSentences();
  }

  btnCreateList.addEventListener('click', async ()=>{
    const name = newListName.value.trim(); if(!name) return alert('Nh·∫≠p t√™n danh s√°ch');
    if(currentUser) await createListFirestore(name); else { const id='local_'+Date.now(); lists[id]={name, sentences:[]}; saveListsToLocal(); renderListsUI(); }
    newListName.value='';
  });

  btnDeleteList.addEventListener('click', async ()=>{
    if(!currentListId) return alert('Ch·ªçn danh s√°ch ƒë·ªÉ x√≥a');
    if(!confirm('Xo√° danh s√°ch hi·ªán t·∫°i?')) return;
    if(currentUser){ await deleteListFirestore(currentListId); } else { delete lists[currentListId]; saveListsToLocal(); currentListId=null; renderListsUI(); }
  });

  selectList.addEventListener('change', ()=>selectListById(selectList.value));

  btnLoadDemo.addEventListener('click', ()=>{ inputSentences.value = ['This is a cat.','I like apples.','She is reading a book.','Do you speak English?','They went to the market.'].join('\n'); });

  // Add sentences
  btnAddSentences.addEventListener('click', async ()=>{
    const raw = inputSentences.value.trim(); if(!raw) return;
    const lines = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    if(!currentListId){
      if(currentUser) currentListId = (await createListFirestore('New list')).toString();
      else { currentListId = 'local_'+Date.now(); lists[currentListId] = {name:'New list', sentences:[]}; }
    }
    for(const line of lines){
      lists[currentListId].sentences = lists[currentListId].sentences || [];
      lists[currentListId].sentences.push({text: line, correctCount: 0});
    }
    if(currentUser) await saveListToFirestore(currentListId); else saveListsToLocal();
    inputSentences.value=''; renderSentences(); renderListsUI();
  });

  btnClearSentences.addEventListener('click', ()=>{ inputSentences.value=''; });

  btnImport.addEventListener('click', ()=>{ const text = prompt('Paste danh s√°ch c√¢u (m·ªói d√≤ng 1 c√¢u)'); if(text) inputSentences.value=text; });
  btnExport.addEventListener('click', ()=>{
    if(!currentListId) return alert('Ch·ªçn danh s√°ch ƒë·ªÉ export');
    const arr = lists[currentListId].sentences||[];
    const out = arr.map(s=>s.text).join('\n');
    const blob = new Blob([out],{type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=(lists[currentListId].name||'sentences')+'.txt'; a.click(); URL.revokeObjectURL(url);
  });

  // Render sentences with buttons and features (including delete)
  function renderSentences(){
    sentencesEl.innerHTML=''; 
    if(!currentListId || !lists[currentListId]) return sentencesEl.innerHTML='<div class="small">Ch·ªçn ho·∫∑c t·∫°o danh s√°ch ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>';
    const arr = lists[currentListId].sentences || [];
    arr.forEach((item, idx)=>{
      const row = document.createElement('div'); row.className='sentence-row';
      const top = document.createElement('div'); top.className='sentence-top';
      const textWrap = document.createElement('div'); textWrap.className='sentence-text';
      textWrap.innerHTML = item.text.split(/(\s+)/).map(tok=>{
        if(tok.trim()==='') return tok;
        return `<span class="word" data-word="${encodeURIComponent(tok)}">${escapeHtml(tok)}</span>`;
      }).join('');
      const icons = document.createElement('div'); icons.className='icons';
      const playBtn = document.createElement('button'); playBtn.className='icon-btn'; playBtn.title='Play sentence'; playBtn.innerHTML='üîä'; playBtn.onclick=()=>speak(item.text);
      const micBtn = document.createElement('button'); micBtn.className='icon-btn'; micBtn.title='Record and compare'; micBtn.innerHTML='üé§'; micBtn.onclick=()=>startRecognition(item, row, idx);
      const resetBtn = document.createElement('button'); resetBtn.className='icon-btn'; resetBtn.title='Reset count'; resetBtn.innerHTML='‚Ü∫'; resetBtn.onclick=async ()=>{ if(confirm('Reset s·ªë l·∫ßn ƒë√∫ng v·ªÅ 0?')){ item.correctCount=0; if(currentUser) await saveListToFirestore(currentListId); else saveListsToLocal(); renderSentences(); } };
      const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.title='Delete sentence'; delBtn.innerHTML='üóëÔ∏è'; delBtn.onclick=async ()=>{
        if(!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën xo√° c√¢u n√†y?')) return;
        lists[currentListId].sentences.splice(idx,1);
        if(currentUser) await saveListToFirestore(currentListId); else saveListsToLocal();
        renderSentences(); renderListsUI();
      };

      icons.appendChild(playBtn); icons.appendChild(micBtn); icons.appendChild(resetBtn); icons.appendChild(delBtn);
      top.appendChild(textWrap); top.appendChild(icons);
      row.appendChild(top);

      const meta = document.createElement('div'); meta.className='meta';
      meta.innerHTML = `ƒê√∫ng to√†n c√¢u: <strong>${item.correctCount||0}</strong> <span style="margin-left:8px" class="small recognized">(B·∫°n ch∆∞a n√≥i)</span>`;
      row.appendChild(meta);

      sentencesEl.appendChild(row);

      // per-word click to speak
      row.querySelectorAll('.word').forEach(w=>{
        w.addEventListener('click', ()=>{ const raw = decodeURIComponent(w.dataset.word); speak(raw); });
      });
    });
  }

  // ========== Speech Synthesis (TTS) ==========
  let voices = [];
  function populateVoices(){
    // L·ªçc ch·ªâ l·∫•y gi·ªçng ti·∫øng Anh
    voices = speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('en'));
    voiceSelect.innerHTML = '';
    
    voices.forEach((v,i)=>{
      const label = `${v.name} (${v.lang})`;
      const opt = document.createElement('option');
      opt.value = v.name; // S·ª≠ d·ª•ng t√™n gi·ªçng n√≥i l√†m gi√° tr·ªã
      opt.textContent = label;
      voiceSelect.appendChild(opt);
    });
    
    // Kh√¥i ph·ª•c config n·∫øu c√≥
    const cfg = JSON.parse(localStorage.getItem(LS_CONFIG)||'{}');
    if(cfg.voice) {
      voiceSelect.value = cfg.voice;
    } else if (voiceSelect.options.length > 0) {
      voiceSelect.value = voiceSelect.options[0].value;
    }
  }
  populateVoices();
  if(typeof speechSynthesis !== 'undefined') speechSynthesis.onvoiceschanged = populateVoices;

  function speak(text){
    if(!('speechSynthesis' in window)) return alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ speechSynthesis');
    const u = new SpeechSynthesisUtterance(text);
    // T√¨m gi·ªçng n√≥i t·ª´ t√™n ƒë√£ l∆∞u
    const selectedVoice = voices.find(v => v.name === voiceSelect.value);
    if(selectedVoice) u.voice = selectedVoice;
    u.rate = parseFloat(rateEl.value||1);
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
    // L∆∞u t√™n gi·ªçng n√≥i v√†o config
    saveConfig({voice: voiceSelect.value, rate: rateEl.value});
  }
  btnTestVoice.addEventListener('click', ()=>speak('This is a test. Hello!'));

  // ========== Speech Recognition (ASR) and comparison ==========
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
  function startRecognition(item, row, idx){
    if(!SpeechRecognition) return alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ SpeechRecognition (ASR). D√πng Chrome tr√™n desktop ƒë·ªÉ c√≥ tr·∫£i nghi·ªám t·ªët nh·∫•t).');
    const recogDiv = row.querySelector('.recognized');
    const wordEls = row.querySelectorAll('.word');

    const rec = new SpeechRecognition();
    rec.lang = 'en-US';
    rec.interimResults = false;
    rec.maxAlternatives = 1;
    recogDiv.textContent = 'Listening...';
    rec.start();

    rec.onresult = async (e)=>{
      const transcript = e.results[0][0].transcript;
      recogDiv.textContent = transcript;
      highlightComparison(item.text, transcript, wordEls);

      const normExp = normalizeText(item.text);
      const normRec = normalizeText(transcript);
      if(normExp === normRec){
        item.correctCount = (item.correctCount||0) + 1;
        if(currentUser) await saveListToFirestore(currentListId); else saveListsToLocal();
        row.querySelector('.meta strong').textContent = item.correctCount;
      }
    };
    rec.onerror = (err)=>{ recogDiv.textContent = 'Error: '+(err.error || err.message || 'unknown'); };
    rec.onend = ()=>{ /* do nothing */ };
  }

  // naive comparison & highlight
  function highlightComparison(expectedText, recognizedText, wordElements){
    const expWords = expectedText.split(/\s+/).map(w=>normalizeText(w)).filter(Boolean);
    const recWords = recognizedText.split(/\s+/).map(w=>normalizeText(w)).filter(Boolean);
    // Try align by index, but also mark correct if present anywhere
    wordElements.forEach((el, i)=>{
      const w = normalizeText(decodeURIComponent(el.dataset.word));
      let isCorrect = false;
      if(recWords[i] && recWords[i] === w) isCorrect = true;
      else if(recWords.includes(w)) isCorrect = true;
      if(isCorrect){ el.classList.add('correct'); el.classList.remove('wrong'); }
      else { el.classList.add('wrong'); el.classList.remove('correct'); }
    });
  }

  // ========== Save on leave ==========
  window.addEventListener('beforeunload', ()=>{ if(!currentUser) saveListsToLocal(); saveConfig({voice: voiceSelect.value, rate: rateEl.value}); });

  // ========== Init: load local lists (if any) ==========
  function loadListsFromLocal(){ try{ lists = JSON.parse(localStorage.getItem(LS_KEY) || '{}') || {}; renderListsUI(); }catch(e){ lists = {}; } }
  loadListsFromLocal();

  // ========== Config save ==========
  function saveConfigLocal(cfg){ localStorage.setItem(LS_CONFIG, JSON.stringify(cfg)); }
  function loadConfigLocal(){ try{ const cfg = JSON.parse(localStorage.getItem(LS_CONFIG)||'{}'); applyConfig(cfg);}catch(e){} }
  loadConfigLocal();

  // Expose some functions for console/testing
  window.speak = speak;
  window.renderListsUI = renderListsUI;
  window.renderSentences = renderSentences;

  </script>
</body>
</html>
